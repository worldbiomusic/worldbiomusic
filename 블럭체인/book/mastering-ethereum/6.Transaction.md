# 트랜잭션이란
- 어떤 데이터를 담고 네트워크로 전송되고 박스
- 트랜잭션은 블럭체인에 데이터를 저장할때 주로 사용됨

## 이더리움에서는
- EOA가 서명한 메세지
- 이더리움에서는 `EVM상태 변경`이나 `컨트랙트를 실행`시킬수 있는 유일한 방법

--- 

# 구조
- 네트워크로 전송되는 비트형태로 Serialized 데이터
- `Nonce`:  메세지에 포함된 단순한 숫자
- `Gas price`: 보내는 사람이 넣은 돈
- `Gas limit`: 트랜잭션을 위해 지불할 최대 가스량
- `Recipient`: 목적지
- `Value`: 보낼 이더 양
- `Data`: 데이터 페이로드
- `v, r, s`: 보낸사람을 증명하는 요소 3개

### 데이터 가공
- 지갑 어플에서 보여주는 정보들중 일부는 트랜잭션 데이터에 실제로 포함되어 있는것이 아닌, 데이터를 가공해서 보여주는 것
> 발신자 주소는 데이터에 포함되어 있지 않고, 발신자의 `v`, `r`, `s`와 같은 전자 서명 데이터로 추적함

---

# 논스
- 트랜잭션에 포함한 숫자
- p2p같은 `분산시스템`에서 트랜잭션의 정상적인 사용(기능성, 복제 방지)을 위해 쓰임
- 트랜잭션 처리를 위한 방법이 UTXO인 비트코인과 달리 Account-based 방식이므로 필수적으로 필요한 방법 (이더리움은 트랜잭션은 블럭체인에서 영구저장, 계정 상태는 UTXO처럼 임시 데이터 셋으로 관리(root hash digest를 block에 기록하면서, [참고](https://hackernoon.com/getting-deep-into-ethereum-how-data-is-stored-in-ethereum-e3f669d96033?ref=hackernoon.com))

## 순서 유지
- 적은 논스를 가진 트랜잭션이 먼저 처리되야 뒤의 큰 논스를 가진 트랜잭션이 처리될 수 있음
- 1이더(논스0), 2이더(논스1) 2개의 트랜잭션을 전송하면 무조건 1이더(논드0)이 먼저 처리됨

## 복제 방지
- 만약에 논스의 개념이 없다면 Account-based 시스템에서는 똑같은 트랜잭션을 다시 보내도 이는 2번 결제가 이루어진것으로 판단하기 때문에 트랜잭션이 송신자가 보낸 트랜잭션을 복제해서 퍼뜨려서 여러번의 중복결제가 되게 할 수 있는 문제점이 있음

## 추적
- 자신이 사용한/사용하려는 트랜잭션 논스값을 추적할 수 있음
- web3 lib: `web3.eth.getTransactionCount("0x1a2a3a4a")`
> 트랜잭션을 짧은 시간안에 여러개를 빠르게 전송하면 네트워크가 논스값을 정확히 추적하기 힘들어서 `getTransactionCount()`가 제대로 동작하지 않음 (전파되야 하기 때문)  

## 간격
- 여러개의 트랜잭션은 가지고 있는 논스값에따라서 순차적으로 처리됨
- `전파속도의 문제`, `트랜잭션의 유효성` 문제등의 이유로 중간 논스값을 가진 트랜잭션이 취소되면 이전의 것과 이후에 것과의 간격이 생김
- 이 간격을 해결하는 방법은 오직 누락된 논스를 가진 트랜잭션을 다시 전송하는 것 뿐임
- 트랜잭션 회수가 불가능

## 중복
- 같은 논스를 가진 같은 내용의 트랜잭션은 하나의 트랜잭션이므로 결과적으로 하나의 트랜잭션만 처리됨
- 같은 논스를 가진 다른 내용의 트랜잭션은 두개의 트랜잭션이므로 이것은 네트워크상의 트랜잭션의 전파속도에 따라 다른 더 빨리 전파된 트랜잭션이 처리되는 결과를 가짐

## 동시 실행
- 이상적인 거래소는 `단일 실패 지점`, `병목 현상`을 방지하기 위해 여러대의 컴퓨터가 같은 트랜잭션을 전파함
- 하지만, 여러 지갑의 동시 실행은 전파할 트랜잭션의 동기화 문제를 해결해야 함
### 해결책
1. 단일 컴퓨터가 트랜잭션을 전파하는것 (`단일 실패 지점`, `병목 현상`)
2. 여러대의 노드가 트랜잭션을 논스값 없이 전파후, 단일 노드가 트랜잭션들의 논스를 설정해주는것 (적은 `단일 실패 지점`, `병목 현상`)
3. 여러개의 핫월렛을 사용

---

# 가스
- 트랜잭션이 처리되기 위해 사용되는 수수료
- 채굴자들과 거래자들간의 시장원리에 의해 가격이 변동됨
- 이더와 환율을 가짐
- 트랜잭션 처리 기준을 수치적으로 명시하기 좋음
- 단위: WEI (10^-18 ETH)
- 대부분의 블럭체인과 마찬가지로 트랜잭션 처리 속도와 수수료는 trade-off 관계
> 전송 gas: 21,000, gas price: 100, ETH = 4,000,000원  
> = 21000 x 100GWEI = 0.0021 ETH = 8,000원

## 가스 제한
- 컨트랙트 실행과 같은 동작을 예측하기 힘든 것은 필요한 가스의 양에 대한 제한을 설정해서 제한까지만 소모되게 할 수 있음

---

# 트랜잭션 
## 수신자
- `EOA` 또는 `컨트랙트` 주소
- 존재하지 않는 주소로 이더를 보내면 사실상 소멸

### 의도적인 가스 연소
- 트랜잭션 부정행위를 방지
- 발행량이 무한인 이더 가치를 높여 인플레이션 방지


## 값, 데이터
- `값`: 이더
- `데이터`: 컨트랙트 호출
- 트랜잭션에는 `값`과 `데이터` 두개를 선택적으로 포함할 수 있음

### 목적지 주소
#### EOA
- `값`: 송신자 EOA 주소에 이더를 보냄
- `데이터`: 무시됨 (특정한 클라이언트에서 알맞는 반응 가능)
#### 컨트랙트
- `값`: 컨트랙트에 연료 주입
- `데이터`: 컨트랙트 함수를 등록 호출 (남은 이더는 되돌려주거나 컨트랙트가 보유)


## 컨트랙트 생성
- 컨트랙트는 블럭에 등록시켜서 생성할 수 있음
- 블럭에 등록된 후에는 컨트랙트 주소를 참조해서 사용가능

### 생성 방법
- `값`을 넣어놓으면 컨트랙트가 `값`을 가짐
- 컨트랙트는 `데이터`에 바이트코드로 넣음
- 트랜잭션에 받는 주소는 보통 `0`으로 설정
- 트랜잭션이므로 일정량의 수수료 필요

- 사진(p125(2), p126(2), p127(1))
![image](https://user-images.githubusercontent.com/61288262/148327119-af846a9d-4e32-4a85-99d6-be8c5d5eb755.png)
![image](https://user-images.githubusercontent.com/61288262/148327126-82737315-3192-447d-8cb7-5993fa2dd04d.png)
![image](https://user-images.githubusercontent.com/61288262/148327140-cb113b69-cc63-4fda-900c-30b081ec944e.png)


## 전파
- 블럭체인의 동작은 P2P 네트워크 기반 위에서 설계됨
- 이더리움은 데이터 전파를 위해 플러드 라우팅 프로토콜을 사용함
- 각 노드는 받은 트랜잭션의 유효성을 검사후 통과한 데이터를 전파
---

# 디지털 서명
- 아무도 따라할 수 없는 자신의 디지털적인 서명
- `개인키-공개키` 암호학 기법을 토대로 한 기술

## 효과
- 본인 증명
- 부인 방지
- 수정 방지

## 작동
### 서명하기
- 이더리움에서는 트랜잭션을 서명함
- 서명 = `자신의 개인키` + `트랜잭션 데이터`
- 서명값(r, s, v)을 얻어 트랜잭션에 넣어서 본인을 증명
### 서명 인증하기
- 트랜잭션을 보낸 사람의 공개키로 누구나 인증 가능

## 체인 ID
- 블럭체인의 네트워크는 노드가 사용하는 프로토콜이 다르면 하드포크가 일어나 네트워크가 분리됨
- 네트워크가 분리되면 이전에 존재하는 계정들은 분리된 2개의 네트워크에 존재함
- 한 네트워크에서 전송한 트랜잭션은 관련 프로토콜의 변경이 없는 한 하드포크된 비슷한 다른 네트워크에서 복사해서 하드포크된 네트워크로 똑같이 전송되어 처리될 수 있는 위험이 존재
- 체인 ID를 서명데이터에 포함시켜서 프로토콜의 구분을 지어서 위험을 방지

- [사진 p133]
![image](https://user-images.githubusercontent.com/61288262/148327155-c4a49980-00a3-4fd4-94bd-766b1c7a1a85.png)

---

# 전송, 서명 분리
- **보안**을 위해 `개인키 서명`과 `트랜잭션 전송`을 오프라인에서 작업해 온라인으로 전파하는 것
- 거래소의 핫월렛에는 자신의 개인키가 보관되있어 비밀번호만 입력하면 알아서 트랜잭션을 생성해 전파해서 보안이 낮음
- 자신의 컴퓨터에서 인터넷과 연결을 끊은 후 혹은 기타 air-gapped 디바이스에서 오프라인으로 서명을 하고 온라인으로 전송

--- 

# 다중 서명
- 여러사람의 동의하에 사용가능한 계정
- 명령어가 명시되있는 비트코인과 달리 이더리움은 스마트 컨트랙트로 직접 구현하여 사용

---

# 정리
- 노드는 이더리움 네트워크를 트랜잭션으로 움직인다
- 계정 기반이므로 논스가 필요하고 튜링 완전이므로 GAS가 필요하다
- 디지털 서명으로 트랜잭션을 암호화해서 네트워크를 보호한다
- 트랜잭션은 나중에 모여서 네트워크에 블럭이 된다
